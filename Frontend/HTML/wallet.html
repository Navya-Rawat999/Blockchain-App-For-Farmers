<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Connect Wallet - ProduceChain</title>
  <script src="../js/auth-guard.js"></script>
  <link rel="stylesheet" href="../css/main.css">
  <link rel="stylesheet" href="../css/navbar.css">
  <script type="importmap">
    {
      "imports": {
        "ethers": "https://cdn.jsdelivr.net/npm/ethers@6.12.0/dist/ethers.min.js"
      }
    }
  </script>
  <style>
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--border-color);
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <div id="navbar"></div>

  <!-- Main Content -->
  <main class="main-content">
    <div class="container">
      <div style="max-width: 600px; margin: 0 auto; padding: 0 1rem;">
        <h1 style="font-size: 2rem; font-weight: 700; margin-bottom: 1.5rem;">Connect Wallet</h1>

        <div id="alert-container"></div>

        <!-- Wallet Connection Card -->
        <div class="card">
          <div class="wallet-disconnected">
            <div style="text-align: center; font-size: 3rem; margin-bottom: 1rem;">ü¶ä</div>
            <h2 style="font-size: 1.5rem; margin-bottom: 1rem; text-align: center;">Connect Your Wallet</h2>
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem; text-align: center;">
              Connect your MetaMask wallet to interact with the blockchain and manage produce transactions.
            </p>
            <button class="btn btn-primary connect-wallet-btn" style="width: 100%;" onclick="connectWallet()">
              Connect MetaMask
            </button>
          </div>

          <div class="wallet-connected" style="display: none;">
            <div style="text-align: center; font-size: 3rem; margin-bottom: 1rem; color: var(--success);">‚úì</div>
            <h2 style="font-size: 1.5rem; margin-bottom: 1rem; text-align: center;">Wallet Connected</h2>
            
            <div style="display: grid; gap: 0.75rem; margin-bottom: 1.5rem;">
              <div>
                <strong>Address:</strong>
                <code class="wallet-address" style="display: block; font-size: 0.75rem; background-color: rgba(0,0,0,0.3); padding: 0.5rem; border-radius: 0.25rem; margin-top: 0.25rem; word-break: break-all;">
                  Not connected
                </code>
                <button onclick="copyAddress()" style="margin-top: 0.5rem; font-size: 0.875rem;" class="btn btn-ghost">
                  üìã Copy Address
                </button>
              </div>
              <div>
                <strong>Network:</strong>
                <span class="wallet-network">Not connected</span>
              </div>
              <div>
                <strong>Balance:</strong>
                <span id="wallet-balance-display">0.0000</span> ETH
                <button onclick="updateBalance()" style="margin-left: 0.5rem; font-size: 0.875rem;" class="btn btn-ghost">
                  üîÑ Refresh
                </button>
              </div>
            </div>

            <button class="btn btn-outline disconnect-wallet-btn" style="width: 100%;" onclick="disconnectWallet()">
              Disconnect Wallet
            </button>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <p>&copy; 2025 Kissan Sathi. Built for transparent agriculture.</p>
  </footer>

  <!-- Scripts - Load in correct order -->
  <script type="module">
    // Import modules
    import utils from '../js/utils.js';
    import '../js/navbar.js';
    import centralizedWallet from '../js/wallet.js';
    import { ethers } from 'ethers';
    
    // Define global functions FIRST before DOMContentLoaded
    window.connectWallet = async () => {
      try {
        const result = await centralizedWallet.connectWallet();
        await updateWalletUI(true);
        showAlert('Wallet connected successfully!', 'success');
      } catch (error) {
        console.error('Connection error:', error);
        showAlert('Failed to connect wallet: ' + error.message, 'error');
      }
    };
    
    window.disconnectWallet = async () => {
      try {
        await centralizedWallet.disconnectWallet();
        await updateWalletUI(false);
        showAlert('Wallet disconnected successfully!', 'success');
      } catch (error) {
        console.error('Disconnection error:', error);
        showAlert('Failed to disconnect wallet: ' + error.message, 'error');
      }
    };
    
    window.copyAddress = () => {
      centralizedWallet.copyAddress();
    };
    
    window.updateBalance = async () => {
      try {
        const balance = await centralizedWallet.updateBalance();
        if (balance !== null) {
          document.getElementById('wallet-balance-display').textContent = parseFloat(balance).toFixed(4);
          showAlert('Balance updated!', 'success');
        }
      } catch (error) {
        console.error('Balance update error:', error);
        showAlert('Failed to update balance', 'error');
      }
    };
    
    // Wait for wallet to be ready and check connection
    document.addEventListener('DOMContentLoaded', async () => {
      // Check authentication first
      if (!(await utils.checkAuth())) {
        utils.redirect('login.html');
        return;
      }

      try {
        await centralizedWallet.waitForReady();
        
        if (centralizedWallet.isWalletConnected()) {
          // Already connected, update UI
          await updateWalletUI(true);
        } else {
          // Not connected, show connection interface
          await updateWalletUI(false);
        }
      } catch (error) {
        console.error('Wallet initialization error:', error);
        showErrorMessage('Failed to initialize wallet service: ' + error.message);
      }
    });
    
    // Update UI based on connection status
    async function updateWalletUI(connected) {
      const disconnectedDiv = document.querySelector('.wallet-disconnected');
      const connectedDiv = document.querySelector('.wallet-connected');

      if (connected && centralizedWallet.getAddress()) {
        disconnectedDiv.style.display = 'none';
        connectedDiv.style.display = 'block';

        // Update address
        const addressElement = document.querySelector('.wallet-address');
        if (addressElement) {
          addressElement.textContent = centralizedWallet.getAddress();
        }

        // Get and display network
        try {
          const provider = centralizedWallet.getProvider();
          const network = await provider.getNetwork();
          const networkName = centralizedWallet.getNetworkName(Number(network.chainId));
          const networkElement = document.querySelector('.wallet-network');
          if (networkElement) {
            networkElement.textContent = networkName;
          }
        } catch (error) {
          console.error('Error getting network:', error);
        }

        // Get and display balance
        try {
          const provider = centralizedWallet.getProvider();
          const balance = await provider.getBalance(centralizedWallet.getAddress());
          const balanceInEth = ethers.formatEther(balance);
          const balanceElement = document.getElementById('wallet-balance-display');
          if (balanceElement) {
            balanceElement.textContent = parseFloat(balanceInEth).toFixed(4);
          }
        } catch (error) {
          console.error('Error getting balance:', error);
        }
      } else {
        disconnectedDiv.style.display = 'block';
        connectedDiv.style.display = 'none';
      }
    }
    
    // Helper functions
    function showAlert(message, type) {
      const alertContainer = document.getElementById('alert-container');
      const alertClass = type === 'success' ? 'alert-success' : type === 'error' ? 'alert-error' : 'alert-warning';
      
      alertContainer.innerHTML = `
        <div class="alert ${alertClass}" style="margin-bottom: 1rem;">
          ${message}
        </div>
      `;
      
      setTimeout(() => {
        alertContainer.innerHTML = '';
      }, 5000);
    }
    
    function showErrorMessage(message) {
      const container = document.querySelector('.container');
      container.innerHTML = `
        <div style="text-align: center; padding: 2rem;">
          <div style="font-size: 3rem; margin-bottom: 1rem; color: var(--error);">‚ö†Ô∏è</div>
          <h2 style="color: var(--error);">Wallet Service Error</h2>
          <p style="margin-bottom: 1rem;">${message}</p>
          <button onclick="window.location.reload()" class="btn btn-primary">
            üîÑ Refresh Page
          </button>
        </div>
      `;
    }
  </script>
</body>    </div>
</html>
